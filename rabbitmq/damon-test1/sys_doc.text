// 多用户使用rabbitmq传递消息的测试模型系统
// liuzhengyi
// 2013-05-13

系统效果
==================================================
三个普通用户分别可以听到指定部门的消息，用户还可以使用自定义的规则，过滤消息；
三个普通用户分别可以向指定部门写消息。

u1可以向部门1写消息，可以收听部门1的消息；
u2可以向部门1和部门2写消息，可以收听部门2的消息；
u3可以向部门2写消息，可以收听部门1和部门2的消息；

系统使用
==================================================
准备工作
	配置好rabbitmq server
	创建一个vhost /v1，
	创建系统说明中的四个用户，
	然后给四个用户配置好相应权限，
运行construct.php创建并初始化相应的exchange和queue
运行p1.php p2.php p3.php各一次，可以看到屏幕提示，向交换机发送了多少条消息。
然后运行c1.php 可以看到u1从服务器中读到了哪些消息；
依次运行c2.php c3.php，观察提示消息。

可以多次运行cn.php 和 pn.php 
最后运行destruct.php 销毁交换机和队列。

系统说明
=========================================
系统设定了四个测试用户：
u1:rmq101u1 u2:rmq201u1 u3:rmq201u2 u4:admin
u1 u2 和 u3是系统的使用者，可以收发消息。
u4是管理者，不能收发消息，只能创建或销毁交换机和队列。
三个使用者隶属于两个部门，u1属于部门1，u2和u3属于部门2。

系统设定了2个交换机，(ex1:rmq101ex, ex2:rmq201ex，每个部门一个)。
系统设定了3个队列。每个用户拥有一个和自己的名字唯一关联的队列。用户只能读自己的队列。
用户可以尝试绑定任何在自己的访问权限以内的队列，用户还可以使用routing key来过滤信息。

三个用户的权限分别为：
u1: 向ex1发送消息；从ex1接收消息；
u2：向ex1和ex2发送消息；从ex2接收消息；
u3：向ex2发送消息，从ex2和ex1接受消息。
在rmq中表示为(使用 sudo rabbitmqctl list_permissions -p /v1)
rmq101u1	^$	^rmq101*	^rmq101*
rmq201u1	^$	^rmq[12]01*	^rmq201*
rmq201u2	^$	^rmq201*	^rmq[12]01*
admin	.*	^$	^$

系统具有多播功能，即向ex2发送的消息，所有监听ex2的用户都能收到一份，ex1也一样。


系统设计记录(普通使用者请忽略以下内容)
=============================================
exchange: (一个exchange相当于一个部门)
rmq101ex (topic) rmq201ex (topic)

queue: (one queue per user)
rmq101qu1 rmq201qu1 rmq201qu2

rmq101u1(c1 p1)
	写rmq101ex
	监听rmq101ex
	bind rmq101qu1
rmq201u1(c2 p2) ('^$','^rmq[12]01*','^rmq201*')
	写rmq201ex和rmq101ex
	监听rmq201ex
	bind rmq201qu1
rmq201u2(c3 p3])
	写rmq201ex
	监听rmq101ex和rmq201ex
	bind rmq201qu2
admin
	管理所有rmq开头的资源

测试方案：
========================
配置好rabbitmq server
运行consturct.php

p1 p2 p3 各运行一次：
则
ex1 中有两份消息
ex2 有两份消息

此时	运行c1应该收到两份消息
	运行c2应该收到两份消息
	运行c3应该收到四份消息

